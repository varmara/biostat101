---
title: Пропорции и частоты
subtitle: "Основы биостатистики, осень 2022"
author: 
  - Марина Варфоломеева
company: 'Каф. Зоологии беспозвоночных, СПбГУ'
output:
  xaringan::moon_reader:
    self-contained: true
    lib_dir: libs
    css: [ninjutsu, "assets/xaringan-themer.css", "assets/xaringan.css"]
    df_print: default
    nature:
      highlightStyle: googlecode
      highlightLines: true
      countIncrementalSlides: false
      titleSlideClass: [middle, left, inverse]
      beforeInit: "assets/macros.js"
    includes:
      in_header: "assets/xaringan_in_header.html"
      after_body: "assets/xaringan_after_body.html"
---


```{r setup, include = FALSE, cache = FALSE, purl = FALSE, fig.showtext = TRUE}
source("assets/setup.R")
knitr::opts_chunk$set(dev.args = list(png  = list(type = "cairo")))
library(xaringanExtra)
use_tile_view()
use_scribble()
use_search(show_icon = FALSE)
use_progress_bar(color = "#6d2b5e", location = "bottom", height = "10px")
use_freezeframe()
# use_webcam()
# use_panelset()
# use_extra_styles(hover_code_line = TRUE)

# http://tachyons.io/docs/
# https://roperzh.github.io/tachyons-cheatsheet/
use_tachyons()

# library(renderthis)
# to_pdf(from = "07-probabilities.Rmd",
#        to = "07-probabilities.pdf",
#        complex_slides = TRUE, partial_slides = TRUE)
```

```{r libs, include=FALSE, warning=FALSE}
library(tidyverse)
library(cowplot)
library(scales)
```


## Пропорции и относительные частоты (доли)

- Биномиальное распределение
- Биномиальный тест для пропорций
- Доверительные интервалы для пропорций

---

class: middle, center, inverse

# Биномиальное распределение

---

## Биномиальное распределение

Случайные события с двумя исходами:

- Бросок монетки:
  - орел
  - решка
- Использование рук
  - правша
  - левша
- Заболевание
  - заболел
  - остался здоров
- Сложная операция, тяжелая болезнь или катастрофа
  - выжил
  - умер

Условно одно из событий в паре называют "успех", а другое — "неудача".

__Биномиальное распределение__ описывает вероятность того, сколько раз будет наблюдаться "успех" при определенном числе испытаний, когда вероятность успеха одинакова во всех испытаниях.

---

## Формула биномиального распределения

$$P(X~'успехов') = \binom{n}{X} \pi^X (1 - \pi)^{n-X} = \frac{n!}{X! (n-X)!} \pi^X (1 - \pi)^{n-X}$$

.pull-left[

```{r binomial-distr, echo=FALSE, purl=FALSE, opts.label='fig.medium.taller'}
mu1 <- 0.1
mu2 <- 0.5
N1 <- 10
N2 <- 50
y <-seq(0, 35, by = 1)
dfr <- data.frame(y = rep(y, 4), p = c(dbinom(y, size = N1, prob = mu1), dbinom(y,  size = N2, prob = mu1), dbinom(y,  size = N1, prob = mu2), dbinom(y,  size = N2, prob = mu2)),  pi = rep(c(mu1, mu2), each = 2*length(y)), n = rep(c(N1, N2, N1, N2), each = length(y)))

ggplot(dfr, aes(x = y, y = p)) + 
  geom_bar(stat = "identity", fill = 'grey20') + facet_grid(n ~ pi,  labeller = label_bquote(rows = n==.(n), cols = pi==.(pi))) + 
  # ggtitle("Биномиальное распределение \nпри разных параметрах") + 
  labs(x = "Число 'успехов'", y = "Вероятность")
```

]

.pull-right[

Параметры:

- $n$ — число испытаний (фиксированное), испытания независимы друг от друга
- $\pi$ — вероятность успеха одинакова во всех испытаниях.

<br/>

Биномиальный коэффициент описывает **число сочетаний из $n$ по $X$**

$$\binom{n}{X} = C_n^X = \frac{n!}{X! \cdot (n-X)!}$$ 
]

---

## Смысл биномиального коэффициента (1)

Пусть перед нами 5 улиток: 3 .red[заражены трематодами (i)], а 2 .blue[здоровы (h)]. Сколькими возможными способами могут быть расположены эти улитки?

-----

( - )   ( - )   ( - )   ( - )   ( - )

--

1-я зараженная улитка может быть расположена 5-ю способами. Допустим, так:

( - )   .red[(i-1)]   ( - )   ( - )   ( - )

--

2-я — 4-мя способами, допустим так:

( - )   .red[(i-1)]   ( - )   ( - )   .red[(i-2)]

--

Третья — 3-мя способами, допустим так:

.red[(i-3)]   .red[(i-1)]   ( - )   ( - )   .red[(i-2)]

Общее число способов, которыми могут располагаться эти зараженные улитки, _если бы они были различимы_: $5 \cdot 4 \cdot 3$

--

Но нам не важен порядок, поэтому разные варианты расположения трех зараженных улиток эквивалентны. Например вот эти два (а всего их $3 \cdot 2 \cdot 1$):

.red[(i-1)]   .red[(i-2)]   ( - )   ( - )   .red[(i-3)]  
.red[(i-3)]   .red[(i-2)]   ( - )   ( - )   .red[(i-1)] 

Поэтому число способов, которыми могут располагаться зараженные улитки, _если они не различимы_ (т.е. если нам не важен их порядок):  
$\cfrac{5 \cdot 4 \cdot 3}{3 \cdot 2 \cdot 1} = 10$

---

## Смысл биномиального коэффициента (2)

Пусть перед нами 5 улиток: 3 .red[заражены трематодами (i)], а 2 .blue[здоровы (h)]. Сколькими возможными способами могут быть расположены эти улитки?

-----

( - )   ( - )   ( - )   ( - )   ( - )

--

1-я здоровая улитка может быть расположена 5-ю способами. Допустим, так:

( - )   ( - )   ( - )   .blue[(h-1)]   ( - )

--

2-я здоровая — 4-мя способами, допустим так:

.blue[(h-2)]   ( - )   ( - )   .blue[(h-1)]   ( - )

<br/>

Общее число способов, которыми могут располагаться эти 2 здоровые улитки, _если бы они были различимы_: $5 \cdot 4$

--

Но нам не важен порядок, поэтому разные варианты расположения 2 здоровых улиток эквивалентны (и всего их $2 \cdot 1$):

.blue[(h-2)]   ( - )   ( - )   .blue[(h-1)]   ( - )  
.blue[(h-1)]   ( - )   ( - )   .blue[(h-2)]   ( - )

Поэтому число способов, которыми могут располагаться 2 здоровые улитки, _если они не различимы_ (т.е. если нам не важен их порядок):  
$\cfrac{5 \cdot 4}{2 \cdot 1} = 10$, так же, как в прошлый раз, но формула другая. Непорядок!

---

## Смысл биномиального коэффициента (3)

Пусть перед нами 5 улиток: 3 .red[заражены трематодами (i)], а 2 .blue[здоровы (h)]. Сколькими возможными способами могут быть расположены эти улитки?

-----

Как из этих двух формул сделать одну, чтобы было все равно с кого начинать — со здоровы или зараженных улиток?

$\cfrac{5 \cdot 4 \cdot 3}{3 \cdot 2 \cdot 1} = 10$, 
$\cfrac{5 \cdot 4}{2 \cdot 1} = 10$

--

Домножим числитель и знаменатель на одно и то же число:

$\cfrac{(5 \cdot 4 \cdot 3)\cdot (2 \cdot 1)}{(3 \cdot 2 \cdot 1)\cdot (2 \cdot 1)} = \cfrac{5!}{\color{red}{3}! \color{blue}{2}!}$

--

Легко заметить, что в числителе факториал общего числа улиток, а в знаменателе факториалы каждой из категорий.

$$\binom{n}{X} = C_n^X = \frac{n!}{X! \cdot (n-X)!}$$ 

---

## Вычисляем вероятность <br/>с использованием биномиального распределения

Вы собираете улиток для эксперимента.  
Вероятность того, что случайно выбранная улитка  
окажется зараженной трематодами 0.2.  

Какова вероятность того, что из 5 собранных улиток 3 заражены?

-----

--

- $\color{red}{0.2^3}$ — вероятность того, что 3 улитки будут заражены

- $\color{blue}{(1 - 0.2)^2}$ — вероятность того, что 2 улитки будут здоровы

- $\cfrac{5!}{\color{red}{3}! \color{blue}{2}!}$ — число возможных сочетаний здоровых и зараженных улиток

--

Можно воспользоваться биномиальным распределением:

$$P(X~'успехов') = \frac{n!}{X! (n-X)!} \pi^X (1 - \pi)^{n-X}$$

$$P(3) = \cfrac{5!}{\color{red}{3}! \color{blue}{2}!} \color{red}{0.2^3} \color{blue}{(1 - 0.2)^2} = 10 \cdot 0.008 \cdot 0.64 = 0.0512$$

---

## Биномиальное распределение (количества "успехов")

Пользуясь формулой биномиального распределения можно рассчитать $p$ — вероятность получить любое количество успехов $X$ в $n$ испытаниях.

$$P(X~'успехов') = \frac{n!}{X! (n-X)!} \pi^X (1 - \pi)^{n-X}$$

.pull-left[

Т.е. для нашего примера $p$ — вероятность получить определенное количество зараженных моллюсков в выборке из 5 особей.
```{r binomial-n-p-table}
pi <- 0.2
n <- 5
x <-seq(0, n, by = 1)
probTable <- data.frame(x = x, p = dbinom(x, size = n, prob = pi) )
probTable %>% kable()
```

]
.pull-right[

```{r binomial-n-p-plot, echo=FALSE, purl=FALSE, opts.label='fig.medium.taller'}
pi <- 0.2
n <- 5
x <-seq(0, n, by = 1)
dfr <- data.frame(x = x, p = c(dbinom(x, size = n, prob = pi)))

ggplot(dfr, aes(x = x, y = p)) + 
  geom_col(fill = 'darkcyan', colour = "white") + 
  labs(x = "Число 'успехов'", y = "Вероятность") +
  scale_x_continuous(breaks = y)
```
]


---

## Выборочное распределение доли

.pull-left[

```{r binomial-prop-sampling-dist, echo=FALSE, purl=FALSE, opts.label='fig.medium.tall'}
pi <- 0.2
Ns <- c(10, 30, 100, 500)
nrep <- 10000
set.seed(394)
dfr <- data.frame(
  pi = pi,
  n = rep(Ns, each = nrep),
  p = unlist(lapply(Ns, FUN = function(x) rbinom(nrep, size = x, prob = pi)/x))) 

ggplot(data = dfr, aes(x = p)) + 
    stat_bin(aes(y=..count../sum(..count..)), fill = "darkcyan", colour = "white", binwidth = 0.02) +
    labs(x = "Доля 'успехов'", y = "Вероятность") + 
    coord_cartesian(xlim = c(0, 1)) +
  facet_grid(n ~., labeller = label_both)
```

]

.pull-right[

Если взять множество выборок размером $n$ и в каждой оценить долю "успехов", то получится __выборочное распределение доли__.

$$p = \cfrac{X}{n}$$

Ширина выборочного распределения доли будет зависеть от объема выборки $n$.

__Стандартное отклонение выборочного распределения доли__:

$$\sigma_p=\sqrt{\cfrac{\pi(1-\pi)}{n}}$$

]

--

Т.е. точность оценки доли по выборке будет зависеть от объема выборки.

---

class: middle, center, inverse

# Биномиальный тест

---

## Пример: гены сперматогенеза на Х хромосоме мышей

Из 25 генов сперматогенеза у мышей 10 (40%) расположены на Х хромосоме (Wang et al. 2001).

Если бы гены были распределены по хромосомам случайно, только 6.1% были бы на Х хромосоме (т.к. она содержит 6.1% всех генов).

Свидетельствуют ли эти данные, что гены сперматогенеза у мышей непропорционально часто встречаются на Х хромосоме? 

![:scale 60%](img/WS2015p186f7.2-1.png)

.pull-down[.tiny[рис. 7.2 из Whitlock and Schluter, 2015]]

---

## Биномиальный тест

Биномиальный тест использует биномиальное распределение, чтобы протестировать значимость отличия доли (относительной частоты) "успехов" от определенной величины.

$H_0: \pi = p_0$ — доля "успехов" в генеральной совокупности равна $p_0$

$H_A: \pi \ne p_0$ — доля "успехов" в генеральной совокупности не равна $p_0$

$0 \le p_0 \le 1$

Тестовая статистика — наблюдаемое число "успехов"

<br/>

--

В примере про гены мышей

$H_0: \pi = 0.061$ — на Х хромосоме расположено 6.1% генов сперматогенеза

$H_A: \pi \ne 0.061$ — на Х хромосоме другой процент генов сперматогенеза

Тестовая статистика — наблюдаемое число генов сперматогенеза на Х хромосоме

---

## Биномиальное распределение для $H_0$

$H_0: \pi = 0.061$ — на Х хромосоме расположено 6.1% генов сперматогенеза  
$H_A: \pi \ne 0.061$ — на Х хромосоме другой процент генов сперматогенеза

<br/>

Если $H_0$ справедлива, то число генов, попавших на Х хромосому из 25 генов сперматогенеза описывается биномиальным распределением с параметрами $n = 25$ и $\pi = 0.061$

$$P(X~генов~сперматогенеза~на~Х~хр.) = \frac{25!}{X! (25-X)!} 0.061^X (1 - 0.061)^{25-X}$$

```{r binom-genes, echo=FALSE, purl=FALSE, opts.label='fig.wide'}
pi <- 0.061
n <- 25
x <-seq(0, n, by = 1)
statist <- 10
dstatis <- dbinom(statist, n, pi)
dfr <- data.frame(x = x, p = c(dbinom(x, size = n, prob = pi)))

gg_binom_genes <- ggplot(dfr, aes(x = x, y = p)) + 
  geom_col(fill = 'darkcyan', colour = "white") + 
  labs(x = "Число генов сперматогенеза на Х хромосоме", y = "Вероятность")  +
  coord_cartesian(xlim = c(0, n-1)) +
  scale_x_continuous(breaks = y)

gg_binom_genes_p <- gg_binom_genes +
  annotate(geom = "text", x = statist, y = mean(range(dfr$p)), label = paste(statist, " - наблюдаемое значение"), size = 7, hjust = 0) +
  annotate(geom = "point", x = statist, y = 0, colour = "orangered", size = 3) +
  annotate(geom = "segment", x = statist, y = 0, xend = statist, yend = mean(range(dfr$p)), linetype = "dashed") + 
  annotate(geom = "segment", x = statist, y = dstatis, xend = n, yend = dstatis, size = 1, colour = "orangered") +
  annotate(geom = "text", x = mean(c(n, statist)), y = dstatis, 
           vjust = -0.5, size = 7,
           label = "В двустороннем тесте\np = 2 P(X≥10)")

gg_binom_genes
```

---

## _P_-значение в двустороннем биномиальном тесте

$H_0: \pi = 0.061$ — на Х хромосоме расположено 6.1% генов сперматогенеза  
$H_A: \pi \ne 0.061$ — на Х хромосоме другой процент генов сперматогенеза

<br/>

Наш тест двусторонний (см $H_A$), поэтому p-значение — это 
- вероятность получить при $H_0$ 10 или более генов сперматогенеза на Х хромосоме (правый хвост)
- плюс вероятность получить сравнимо малое количество генов (на другом конце распределения)

```{r binom-genes-p, echo=FALSE, purl=FALSE, opts.label='fig.wide'}
gg_binom_genes_p
```

---

## _P_-значение в двустороннем биномиальном тесте

$H_0: \pi = 0.061$ — на Х хромосоме расположено 6.1% генов сперматогенеза  
$H_A: \pi \ne 0.061$ — на Х хромосоме другой процент генов сперматогенеза

Чтобы вычислить p-значение, придется суммировать эти вероятности и удвоить:

```{r, R.options=list(scipen = 1)}
dfr_full <- data.frame(X = x, p = dbinom(x, size = n, prob = pi))
dfr_p <- dfr_full[dfr_full$X >= statist, ] %>% 
  mutate(p = as.character(signif(p, 3)))
bind_cols(dfr_p[1:4, ], dfr_p[5:8, ], dfr_p[9:12, ], dfr_p[13:16, ]) %>% kable(col.names = rep(c("X", "p"), 4))

pval1 <- sum(dfr_full[dfr_full$X >= statist, "p"])
pval_ch <- as.character(signif(pval1 * 2, 3))
```

Получится `r pval_ch`, т.е. $H_0$ придется отвергнуть.

```{r binom-genes-p, echo=FALSE, purl=FALSE, opts.label='fig.wide'}
```

---

## Аппроксимации биномиального теста

Биномиальный тест дает точные значения p, но вычисления лучше делать не в ручную.

В те времена, когда компьютеры были редкостью, разработали более быстрые приближенные варианты этого теста:

- $\chi^2$ тест качества подгонки ($\chi^2$ goodness of fit test)
- Нормальная аппроксимация биномиального теста



???

Нормальное приближение биномиального теста гл. 10 WS 2015

---

class: middle, center, inverse

# Доверительный интервал для доли

---

## Оценка доли

$$p = \cfrac{X}{n}$$

<br/>

В нашем примере

$p = \cfrac{10}{25} = 0.4$

То есть 40% генов сперматогенеза у мышей лежат на Х хромосоме.

Это точечная оценка. Давайте попробуем построить к ней доверительный интервал.

---

## Стандартная ошибка доли

Когда обсуждали выборочное распределение доли, упоминали, что __стандартное отклонение выборочного распределения доли__):

$$\sigma_p = \sqrt{\cfrac{\pi(1-\pi)}{n}}$$

Ее выборочная оценка — это __стандартная ошибка доли__ $SE_p =\sqrt{\cfrac{p(1-p)}{n}}$

В нашем примере $SE_p =\sqrt{\cfrac{0.4(1-0.4)}{25}} = 0.098$

Эта величина характеризует степень точности нашей оценки доли генов на Х хромосоме в генеральной совокупности.

???

WS отмечают (p.179 Whitlock, Schluter, 2015), что в некоторых учебниках делят на (n - 1). Если делить на n - 1, получается менее смещенная оценка, но если делить на n, то оценка будет ближе к $\sigma$.

---

## Доверительный интервал для долей

Существует много методов построения приблизительных доверительных интервалов для долей.

---

## Метод Вальда (Wald, 1939)

Предложен П.С. Лапласом в 1812г.

$p \pm 1.96 SE_p$

<br/>

--

Ограничения:

- Плохо работает при малых объемах выборок
- Когда $p$ близко к 0 или 1 получаются интервалы с выходом за пределы интервала [0, 1])
- Невозможен для $p$ 0 и 1
- Когда $n p < 5$ или $n(1 – p) < 5$ не правильная оценка $SE_p$ т.к. не работает аппроксимация нормальным распределением (Motulsky, 1995)


---

## Метод Агрести-Коулл (Agresti, Coull, 1998)

Приблизительный доверительный интервал

1.Считаем $p$ с поправкой $p^\prime =\cfrac{X + 2}{n + 4}$ 

2.Считаем стандартную ошибку доли с поправкой $SE_p^\prime = \sqrt{\cfrac{p^\prime(1-p^\prime)}{n + 4}}$

3.Вычисляем границы доверительного интервала доли

$$p^\prime - 1.96 \cdot SE_p^\prime < p < p^\prime + 1.96 \cdot SE_p^\prime$$

<br/>

Метод Агрести-Коулл предпочтительнее, чем метод Вальда.

---

class: middle, center, inverse

# Summary

---

## Что почитать








